# Dual Asset System Architecture

## Overview

The FPV Flight Simulator implements a dual asset system that separates internal engine assets from user-provided assets. This architecture ensures that the engine always has access to required assets even when user assets are missing or corrupted.

## Directory Structure

### Internal Assets

```
internal_assets/
├── core/
│   ├── textures/      # Default textures used by the engine
│   ├── fonts/         # Default fonts used by the engine
│   ├── audio/         # Default audio files used by the engine
│   ├── materials/     # Default material definitions
│   ├── meshes/        # Primitive meshes (cube, sphere, plane)
│   ├── shaders/       # Default shaders used by the engine
│   └── internal_assets.xml  # Configuration file for internal assets
├── error.png          # Error texture for fallback
├── error.ttf          # Error font for fallback
└── error.wav          # Error sound for fallback
```

### User Assets

```
assets/
├── default/           # Default assets that can be overridden by packages
├── packages/          # User-defined content packages
│   └── [package]/
│       ├── package.xml  # Package definition
│       ├── assets/      # Assets for this package
│       └── scenes/      # Scenes for this package
├── build_tools/       # Tools for building assets
└── schemas/           # XML schemas for validation
```

## Asset Priority

1. User assets (in `assets/packages/`) have higher priority and will override internal assets with the same ID.
2. Internal assets (in `internal_assets/`) are used as fallbacks when user assets are not available.

## Implementation Details

The `AssetManager` class handles loading and managing both internal and user assets. It provides methods to:

- Load assets from both locations via `initialize(internalAssetsPath, userAssetsPath)`
- Retrieve assets by ID with proper priority handling via `getAssetPath(assetId)`
- Check if assets exist in either location via `assetExists(assetId)`
- Get fallback assets for specific types via `getFallbackAssetPath(assetType)`

## Integration with Package System

The dual asset system integrates with the existing package system:

1. Internal assets are loaded first during bootstrap
2. Package assets are loaded afterward
3. The `AssetRegistry` is populated with both internal and package assets
4. Asset references in scenes and entities are resolved against this combined registry

## Error Handling

If a requested asset is not found in either location, the system will:

1. Log a warning
2. Return the appropriate fallback asset for the requested type
3. Continue execution rather than crashing

This ensures the simulation remains functional even when assets are missing.

## Adding New Assets

### Internal Assets

Internal assets should be added to the appropriate subdirectory in `internal_assets/` and registered in `internal_assets/core/internal_assets.xml` using the following format:

```xml
<asset id="asset_type.asset_name" type="asset_type">
  <path>relative/path/to/asset/file</path>
</asset>
```

### User Assets

User assets can be added to packages in the `assets/packages/` directory. Each package should have a `package.xml` file that defines its assets according to the package specification.

## Asset Compilation

The asset compilation pipeline processes both internal and user assets, optimizing them for runtime performance. The `build_tools/` directory contains scripts for this purpose.
